CXX = g++
CXXFLAGS = -ggdb3 -Wall -Werror -Wno-unused -std=c++11
LDFLAGS = -Wl,-rpath,/usr/local/lib

OPTIMIZATION_LEVEL ?= -O2

OPENCV_INCDIR = /usr/local/include/opencv4
OPENCV_LIBDIR = /usr/local/lib
OPENCV_LIBS = -lopencv_core -lopencv_imgproc -lopencv_highgui -lopencv_imgcodecs

# Exercise 02b variables
EXERCISE_02B_PREFIX = exercise_02b
EXERCISE_02B_TARGET = $(EXERCISE_02B_PREFIX)_compare
EXERCISE_02B_COMPILATION_FILES_FOLDER = $(EXERCISE_02B_TARGET).dSYM
EXERCISE_02B_SOURCE = $(EXERCISE_02B_PREFIX)_compare.cpp
OUTPUT_FILE = $(EXERCISE_02B_PREFIX)_output_01.txt

# Exercise 04a variables
EXERCISE_04A_PREFIX = exercise_04a
EXERCISE_04A_TARGET = $(EXERCISE_04A_PREFIX)_opening
EXERCISE_04A_SOURCES = $(EXERCISE_04A_TARGET).cpp erosion.cpp dilation.cpp
EXERCISE_04A_OBJECTS = $(EXERCISE_04A_SOURCES:.cpp=.o)
EXERCISE_04A_HEADERS = $(EXERCISE_04A_TARGET).hpp erosion.hpp dilation.hpp
EXERCISE_04A_COMPILATION_FILES_FOLDER = $(EXERCISE_04A_TARGET).dSYM
INPUT_IMAGE ?= $(EXERCISE_04A_PREFIX)_input_01.pgm
OUTPUT_IMAGE_1 = $(EXERCISE_04A_PREFIX)_output_01.pgm
OUTPUT_IMAGE_2 = $(EXERCISE_04A_PREFIX)_output_02.pgm
SIZE ?= 1

.PHONY: all exercise_02b exercise_04a run_02b run_04a clean clean_02b clean_04a

all: exercise_02b exercise_04a

exercise_02b: $(EXERCISE_02B_TARGET)

exercise_04a: $(EXERCISE_04A_TARGET)

$(EXERCISE_02B_TARGET): $(EXERCISE_02B_SOURCE)
	$(CXX) $(CXXFLAGS) $(OPTIMIZATION_LEVEL) $(LDFLAGS) -o $@ $< -I$(OPENCV_INCDIR) -L$(OPENCV_LIBDIR) $(OPENCV_LIBS)

$(EXERCISE_04A_TARGET): $(EXERCISE_04A_OBJECTS)
	$(CXX) $(CXXFLAGS) $(OPTIMIZATION_LEVEL) $(LDFLAGS) -o $@ $^ -I$(OPENCV_INCDIR) -L$(OPENCV_LIBDIR) $(OPENCV_LIBS)

%.o: %.cpp $(EXERCISE_04A_HEADERS)
	$(CXX) $(CXXFLAGS) $(OPTIMIZATION_LEVEL) -c -o $@ $< -I$(OPENCV_INCDIR)

run: $(EXERCISE_04A_TARGET) $(EXERCISE_02B_TARGET)
	./$(EXERCISE_04A_TARGET) $(SIZE) $(INPUT_IMAGE) $(OUTPUT_IMAGE_1) && \
	./$(EXERCISE_04A_TARGET) $(SIZE) $(OUTPUT_IMAGE_1) $(OUTPUT_IMAGE_2) && \
	./$(EXERCISE_02B_TARGET) $(OUTPUT_IMAGE_1) $(OUTPUT_IMAGE_2)

clean: clean_02b clean_04a

clean_02b:
	rm -rf $(EXERCISE_02B_TARGET) $(EXERCISE_02B_COMPILATION_FILES_FOLDER) $(OUTPUT_FILE)

clean_04a:
	rm -rf $(EXERCISE_04A_TARGET) $(EXERCISE_04A_OBJECTS) $(EXERCISE_04A_COMPILATION_FILES_FOLDER) $(OUTPUT_IMAGE_1) $(OUTPUT_IMAGE_2)
