CXX = g++
CXXFLAGS = -ggdb3 -Wall -Werror -Wno-unused -std=c++11
LDFLAGS = -Wl,-rpath,/usr/local/lib

OPTIMIZATION_LEVEL ?= -O2

OPENCV_INCDIR = /usr/local/include/opencv4
OPENCV_LIBDIR = /usr/local/lib
OPENCV_LIBS = -lopencv_core -lopencv_imgproc -lopencv_highgui -lopencv_imgcodecs

# Exercise 02b variables
EXERCISE_02B_PREFIX = exercise_02b
EXERCISE_02B_TARGET = $(EXERCISE_02B_PREFIX)_compare
EXERCISE_02B_COMPILATION_FILES_FOLDER = $(EXERCISE_02B_TARGET).dSYM
EXERCISE_02B_SOURCE = $(EXERCISE_02B_PREFIX)_compare.cpp
OUTPUT_FILE = $(EXERCISE_02B_PREFIX)_output_01.txt

# Exercise 04b variables
EXERCISE_04B_PREFIX = exercise_04b
EXERCISE_04B_TARGET = $(EXERCISE_04B_PREFIX)_closing
EXERCISE_04B_SOURCES = $(EXERCISE_04B_TARGET).cpp erosion.cpp dilation.cpp
EXERCISE_04B_OBJECTS = $(EXERCISE_04B_SOURCES:.cpp=.o)
EXERCISE_04B_HEADERS = $(EXERCISE_04B_TARGET).hpp erosion.hpp dilation.hpp
EXERCISE_04B_COMPILATION_FILES_FOLDER = $(EXERCISE_04B_TARGET).dSYM
INPUT_IMAGE ?= $(EXERCISE_04B_PREFIX)_input_01.pgm
OUTPUT_IMAGE_1 = $(EXERCISE_04B_PREFIX)_output_01.pgm
OUTPUT_IMAGE_2 = $(EXERCISE_04B_PREFIX)_output_02.pgm
SIZE ?= 1

.PHONY: all exercise_02b exercise_04b clean clean_02b clean_04b

all: exercise_02b exercise_04b

exercise_02b: $(EXERCISE_02B_TARGET)

exercise_04b: $(EXERCISE_04B_TARGET)

$(EXERCISE_02B_TARGET): $(EXERCISE_02B_SOURCE)
	$(CXX) $(CXXFLAGS) $(OPTIMIZATION_LEVEL) $(LDFLAGS) -o $@ $< -I$(OPENCV_INCDIR) -L$(OPENCV_LIBDIR) $(OPENCV_LIBS)

$(EXERCISE_04B_TARGET): $(EXERCISE_04B_OBJECTS)
	$(CXX) $(CXXFLAGS) $(OPTIMIZATION_LEVEL) $(LDFLAGS) -o $@ $^ -I$(OPENCV_INCDIR) -L$(OPENCV_LIBDIR) $(OPENCV_LIBS)

%.o: %.cpp $(EXERCISE_04B_HEADERS)
	$(CXX) $(CXXFLAGS) $(OPTIMIZATION_LEVEL) -c -o $@ $< -I$(OPENCV_INCDIR)

run: $(EXERCISE_04B_TARGET) $(EXERCISE_02B_TARGET)
	./$(EXERCISE_04B_TARGET) $(SIZE) $(INPUT_IMAGE) $(OUTPUT_IMAGE_1) && \
	./$(EXERCISE_04B_TARGET) $(SIZE) $(OUTPUT_IMAGE_1) $(OUTPUT_IMAGE_2) && \
	./$(EXERCISE_02B_TARGET) $(OUTPUT_IMAGE_1) $(OUTPUT_IMAGE_2)

clean: clean_02b clean_04b

clean_02b:
	rm -rf $(EXERCISE_02B_TARGET) $(EXERCISE_02B_COMPILATION_FILES_FOLDER) $(OUTPUT_FILE)

clean_04b:
	rm -rf $(EXERCISE_04B_TARGET) $(EXERCISE_04B_OBJECTS) $(EXERCISE_04B_COMPILATION_FILES_FOLDER) $(OUTPUT_IMAGE_1) $(OUTPUT_IMAGE_2)
